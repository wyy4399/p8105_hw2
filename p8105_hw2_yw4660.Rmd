---
title: "p8105_hw2_yw4660"
output: html_document
---
```{r, include=FALSE}
library('tidyverse')
library('readxl')
```

## Problem 1
```{r}
# data import
pols <- read_csv("data/fivethirtyeight_datasets/pols-month.csv")

unemployment <- read_csv("data/fivethirtyeight_datasets/unemployment.csv")

# clean data in pols
head(pols)
pols_clean <- pols |>
janitor::clean_names() |>
separate(mon, into = c("year","month","day"), sep = "-", convert = TRUE) |>
mutate(month = month.name[month], president = if_else(prez_gop == 1, "gop", "dem")) |>
select(year, month, president, gov_gop, sen_gop, rep_gop,gov_dem, sen_dem, rep_dem) |>
arrange(year, match(month, month.name))
head(pols_clean)

# clean data in snp
snp  <- read_csv("data/fivethirtyeight_datasets/snp.csv")
head(snp)
snp_clean <- snp |>
janitor::clean_names() |> 
separate(date, into = c("month", "day", "year"), sep = "/") |> 
mutate(year = as.integer(year), year = ifelse(year >= 50, 1900 + year, 2000 + year), month = month.name[as.integer(month)]) |>
select(year, month, close) |>
arrange(year, match(month,month.name))
head(snp_clean)

# Tidy the unemployment data
head(unemployment)
unemployment_tidy <- unemployment |>
janitor::clean_names() |> 
pivot_longer(jan:dec,names_to  = "month",values_to = "unemployment") |>
mutate(month = factor(month, levels = tolower(month.abb), labels = month.name))|>
arrange(year, month)
head(unemployment_tidy)

# Merge the cleaned datasets
pols_snp <- left_join(pols_clean, snp_clean, by = c("year","month"))
head(pols_snp)
final_data <- left_join(pols_snp, unemployment_tidy, by = c("year","month"))
head(final_data)
# Show dimensions of the result
dim(final_data)
```

## Problem 2
```{r}
mr <- read_excel("data/trash_wheel_data.xlsx",
                 sheet = "Mr. Trash Wheel",
                 skip = 1) |>
  select(-starts_with("Unnamed")) |>   
  janitor::clean_names() |>            
  filter(!is.na(dumpster)) |>          
  mutate(
    year  = as.integer(year),
    month = as.character(month),
    date  = as.Date(date),
    sports_balls = as.integer(round(sports_balls)),
    trash_wheel  = "Mr. Trash Wheel"
  )

prof <- read_excel("data/trash_wheel_data.xlsx",
                   sheet = "Professor Trash Wheel",
                   skip = 1) |>
  select(-starts_with("Unnamed")) |>
  janitor::clean_names() |>
  filter(!is.na(dumpster)) |>
  mutate(
    year  = as.integer(year),
    month = as.character(month),
    date  = as.Date(date),
    sports_balls = NA_integer_,
    trash_wheel  = "Professor Trash Wheel"
  )

gwyn <- read_excel("data/trash_wheel_data.xlsx",
                   sheet = "Gwynnda Trash Wheel",
                   skip = 1) |>
  select(-starts_with("Unnamed")) |>
  janitor::clean_names() |>
  filter(!is.na(dumpster)) |>
  mutate(
    month = trimws(as.character(month)),
    year  = as.integer(year),
    date  = as.Date(date),
    sports_balls = NA_integer_,
    trash_wheel  = "Gwynnda Trash Wheel"
  )

trash_all <- bind_rows(mr, prof, gwyn)
head(trash_all)
```
After cleaning and combining the datasets from Mr. Trash Wheel, Professor Trash Wheel, and Gwynnda, the resulting dataset includes `r nrow(trash_all)` observations and `r ncol(trash_all)` variables.  
Key variables include the total weight of trash collected (`weight_tons`), the volume of trash (`volume_cubic_yards`), and counts of specific items such as plastic bottles, polystyrene, cigarette butts, and sports balls.  

Professor Trash Wheel collected a total of **`r round(sum(prof$weight_tons, na.rm = TRUE), 1)` tons** of trash across the available period.  
Meanwhile, Gwynnda collected **`r sum(filter(gwyn, year == 2022, tolower(month) == "june")$cigarette_butts, na.rm = TRUE)` cigarette butts** in June of 2022.

## Problem 3
```{r}
zip_df <- read_csv("data/zillow_data/Zip Codes.csv", show_col_types = FALSE) |>
  distinct(ZipCode, .keep_all = TRUE)
zori_df <- read_csv("data/zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv")
zip_df <- zip_df |>
distinct(ZipCode, .keep_all = TRUE)
head(zip_df)

## create dataset
# Add a numeric ZipCode column to the Zillow data, matching the zip file
zori_df <- zori_df |>
  mutate(ZipCode = as.integer(RegionName))
# Find missing zip


missing_zips_final <- setdiff(zip_df$ZipCode, final_dataset$zip_code)
# Merge the county and neighborhood information onto the Zillow data by ZipCode
zori_merged <- zori_df |>
  left_join(
    zip_df |>
      select(ZipCode, County, Neighborhood),
    by = "ZipCode"
  )

# Identify all columns containing dates (those starting with year)
date_columns <- names(zori_merged)[grepl("^20\\d{2}-\\d{2}-\\d{2}$", names(zori_merged))]

# Pivot from wide to long format:
# Each row will represent one zip code on a specific date, with its rent value.
zori_long <- zori_merged |>
  pivot_longer(
    cols = all_of(date_columns),
    names_to = "date",
    values_to = "rent"
  ) |>
  mutate(date = ymd(date)) |>
  arrange(ZipCode, date)

# Rename columns to a more readable format for the final tidy dataset
final_dataset <- zori_long |>
  rename(
    zip_code = ZipCode,
    borough = County,
    neighborhood = Neighborhood,
    rent_price = rent
  )

head(final_dataset)
total_obs_final     <- nrow(final_dataset)
unique_zips_final   <- n_distinct(final_dataset$zip_code)
unique_neighs_final <- n_distinct(final_dataset$neighborhood)
# Find rental drop during covid
jan2020 <- "2020-01-31"
jan2021 <- "2021-01-31"

drop_table <- final_dataset |>
  filter(date %in% as.Date(c("2020-01-31", "2021-01-31"))) |>
  select(zip_code, borough, neighborhood, date, rent_price) |>
  pivot_wider(names_from = date, values_from = rent_price) |>
  mutate(
    change_2020_to_2021 = `2021-01-31` - `2020-01-31`
  ) |>
  arrange(change_2020_to_2021) |>
  slice(1:10) |>
  select(zip_code, borough, neighborhood, change_2020_to_2021)
```
This tidy dataset contains `r total_obs_final` rows. It includes `r unique_zips_final` unique ZIP codes and `r unique_neighs_final` unique neighborhoods.  

ZIP codes that appear in the ZIP code master list but not in the Zillow rent dataset include `r paste(head(missing_zips_final, 10), collapse = ", ")` (and many more).  Examples such as 10020 (Rockefeller Center), 11371 (LaGuardia Airport) and 10041 (55 Water Street) correspond to major office complexes or transportation hubs rather than residential areas, which is why Zillow has no rental data for them.  

The table below lists the ten ZIP codes with the largest drop in rental price between January 2020 and January 2021, along with their borough and neighborhood.  Inline R code generates this table from `final_dataset`:
